#!/bin/sh
#
# Insert the git commit value into the files in autogen/.
# One problem with this approach is that the build system is
# unaware of these relationships, so will not pick up changes to
# the autogen/ files without manual intervention (e.g. manually
# running `sh configure`).
#
# On heroku, using the buildpack/slug, the git setup has already been
# removed by the time this is run, but fortunately it is available as the
# SOURCE_VERSION environment variable - see
# https://devcenter.heroku.com/changelog-items/630
#
# When building under docker we ensure the git revision is sent in
# using the same environment variable.
#
if [ -z "$SOURCE_VERSION" ]; then
    commit=$(git rev-parse HEAD)
else
    commit="$SOURCE_VERSION"
fi
echo "Using id: $commit"

# Work out where we are (this seems to have changed in Cabal
# circa 2.2.0.1 / ghc 8.4). Very hacky. It is important for
# basedir to end in a / character if set.
#
echo `pwd`
search=autogen/lib-Git.hs.in
if [ -f $search ] ; then
    basedir=`pwd`/
else if [ -f ../../../../../$search ] ; then
         basedir=../../../../../
     else
         echo "*** WARNING: $search not found";
         exit 1;
     fi
fi

echo "basedir=${basedir}"
sed -e s/@@GITHASH@@/$commit/ ${basedir}autogen/lib-Git.hs.in > ${basedir}lib/Git.hs

# end
