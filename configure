#!/bin/sh
#
# Insert the git commit value into the files in autogen/.
# One problem with this approach is that the build system is
# unaware of these relationships, so will not pick up changes to
# the autogen/ files without manual intervention (e.g. manually
# running `sh configure`).
#
# On heroku, using the buildpack/slug, the git setup has already been
# removed by the time this is run, but fortunately it is available as the
# SOURCE_VERSION environment variable - see
# https://devcenter.heroku.com/changelog-items/630
#
# When building under docker we ensure the git revision is sent in
# using the same environment variable.
#
if [ -z "$SOURCE_VERSION" ]; then
    commit=$(git rev-parse HEAD)
else
    commit="$SOURCE_VERSION"
fi
echo "Using id: $commit"

sed -e s/@@GITHASH@@/$commit/ autogen/lib-Git.hs.in > lib/Git.hs

# end
